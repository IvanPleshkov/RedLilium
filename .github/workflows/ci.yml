name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ['*']

env:
  CARGO_TERM_COLOR: always
  # Force software rendering for graphics tests in CI
  LIBGL_ALWAYS_SOFTWARE: 1
  MESA_GL_VERSION_OVERRIDE: 4.5
  MESA_GLSL_VERSION_OVERRIDE: 450
  # Vulkan ICD loader settings (helps find software Vulkan drivers)
  VK_LOADER_DEBUG: all

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================
      # Graphics Drivers (Software Rendering)
      # =========================================

      - name: Install Mesa OpenGL and Vulkan (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            mesa-utils \
            libgl1-mesa-dri \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            mesa-vulkan-drivers \
            vulkan-tools \
            libvulkan1 \
            libvulkan-dev
          # Verify installations
          echo "=== OpenGL Info ==="
          glxinfo -B || true
          echo "=== Vulkan Info ==="
          vulkaninfo --summary || true

      - name: Install Mesa OpenGL and Vulkan (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Download Mesa for Windows (software OpenGL via llvmpipe)
          $mesaVersion = "24.2.4"
          $mesaUrl = "https://github.com/pal1000/mesa-dist-win/releases/download/$mesaVersion/mesa3d-$mesaVersion-release-msvc.7z"

          # Create directory and download
          New-Item -ItemType Directory -Force -Path "$env:TEMP\mesa"
          Invoke-WebRequest -Uri $mesaUrl -OutFile "$env:TEMP\mesa\mesa.7z"

          # Extract using 7z (available on GitHub runners)
          7z x "$env:TEMP\mesa\mesa.7z" -o"$env:TEMP\mesa" -y

          # Copy OpenGL DLLs to a local directory (can't write to System32 in CI)
          # Applications will find these DLLs via PATH
          $mesaLocalDir = "${{ github.workspace }}\mesa-dll"
          New-Item -ItemType Directory -Force -Path $mesaLocalDir
          $mesaDir = "$env:TEMP\mesa\x64"
          Copy-Item "$mesaDir\opengl32.dll" -Destination $mesaLocalDir -Force
          Copy-Item "$mesaDir\libgallium_wgl.dll" -Destination $mesaLocalDir -Force
          Copy-Item "$mesaDir\libglapi.dll" -Destination $mesaLocalDir -Force

          # Add Mesa directory to PATH (prepend so it takes precedence)
          echo "$mesaLocalDir" | Out-File -FilePath $env:GITHUB_PATH -Append

          # Download and install Vulkan SDK for vulkan runtime
          $vulkanSdkVersion = "1.3.290.0"
          $vulkanSdkUrl = "https://sdk.lunarg.com/sdk/download/$vulkanSdkVersion/windows/VulkanSDK-$vulkanSdkVersion-Installer.exe"
          Invoke-WebRequest -Uri $vulkanSdkUrl -OutFile "$env:TEMP\vulkan-sdk.exe"
          Start-Process -FilePath "$env:TEMP\vulkan-sdk.exe" -ArgumentList "/S" -Wait

          # Add Vulkan SDK to PATH
          $vulkanPath = "C:\VulkanSDK\$vulkanSdkVersion\Bin"
          echo "$vulkanPath" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Install Vulkan SDK (macOS)
        if: runner.os == 'macOS'
        run: |
          # Install MoltenVK via Homebrew (Vulkan on Metal)
          brew install molten-vk vulkan-loader vulkan-tools

          # Verify Vulkan installation
          echo "=== Vulkan Info ==="
          vulkaninfo --summary || true

          # Note: macOS has deprecated OpenGL but still provides it via system frameworks
          # No additional OpenGL installation needed

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run test script (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          chmod +x ./scripts/test-all.sh
          ./scripts/test-all.sh --verbose

      - name: Run test script (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: .\scripts\test-all.ps1 -Verbose
