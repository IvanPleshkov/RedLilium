<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphics Engine Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a2e;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #canvas-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.5rem;
            text-align: center;
            z-index: 1000;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            max-width: 80%;
            display: none;
            z-index: 1001;
        }

        #controls-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
        }

        #controls-hint h4 {
            margin-bottom: 10px;
            color: #fff;
        }

        #controls-hint ul {
            list-style: none;
        }

        #controls-hint li {
            margin: 5px 0;
        }

        kbd {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Loading Graphics Engine...</p>
        <p style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 10px;">
            Supports WebGPU and WebGL2
        </p>
    </div>

    <div id="error"></div>

    <div id="canvas-container"></div>

    <div id="controls-hint">
        <h4>Controls</h4>
        <ul>
            <li><kbd>WASD</kbd> - Move camera</li>
            <li><kbd>Q</kbd>/<kbd>E</kbd> - Up/Down</li>
            <li><kbd>Right Mouse</kbd> + drag - Look around</li>
            <li><kbd>C</kbd> - Switch camera mode</li>
            <li><kbd>F1</kbd> - Toggle debug UI</li>
            <li><kbd>Shift</kbd> - Sprint</li>
        </ul>
    </div>

    <script type="module">
        // Check for WebGPU support (returns true if available, false otherwise)
        async function checkWebGPU() {
            if (!navigator.gpu) {
                return false;
            }

            try {
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    return false;
                }
                // Try to request a device to verify WebGPU actually works
                const device = await adapter.requestDevice();
                device.destroy();
                return true;
            } catch (e) {
                console.log('WebGPU check failed:', e);
                return false;
            }
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showBackendInfo(hasWebGPU) {
            const info = document.createElement('div');
            info.id = 'backend-info';
            info.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                color: rgba(255, 255, 255, 0.7);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 0.8rem;
                background: rgba(0, 0, 0, 0.5);
                padding: 8px 12px;
                border-radius: 5px;
                z-index: 100;
            `;
            if (hasWebGPU) {
                info.textContent = 'Backend: WebGPU (full resolution)';
                info.style.borderLeft = '3px solid #4CAF50';
            } else {
                info.textContent = 'Backend: WebGL2 (max 2048px)';
                info.style.borderLeft = '3px solid #FF9800';
            }
            document.body.appendChild(info);
        }

        function clampCanvasForWebGL2() {
            const container = document.getElementById('canvas-container');
            const maxSize = 2048;
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Calculate scaled dimensions maintaining aspect ratio
            if (width > maxSize || height > maxSize) {
                const scale = Math.min(maxSize / width, maxSize / height);
                const clampedWidth = Math.floor(width * scale);
                const clampedHeight = Math.floor(height * scale);

                container.style.width = clampedWidth + 'px';
                container.style.height = clampedHeight + 'px';

                // Center the container
                container.style.margin = 'auto';
                container.style.position = 'absolute';
                container.style.top = '50%';
                container.style.left = '50%';
                container.style.transform = 'translate(-50%, -50%)';

                console.log(`Canvas clamped: ${width}x${height} -> ${clampedWidth}x${clampedHeight} (scale: ${scale.toFixed(3)})`);
            }
        }

        async function init() {
            try {
                // Check WebGPU support
                const hasWebGPU = await checkWebGPU();

                if (!hasWebGPU) {
                    console.log('WebGPU not available, using WebGL2 with 2048px limit');
                    clampCanvasForWebGL2();
                } else {
                    console.log('WebGPU available');
                }

                // Load the WASM module
                const wasm = await import('./pkg/graphics_engine.js');
                await wasm.default();

                hideLoading();
                showBackendInfo(hasWebGPU);

                console.log('Graphics Engine initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showError(error.message || 'Failed to initialize the graphics engine');
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            // The canvas will be resized by winit
        });

        // Prevent context menu on right-click (for camera control)
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        // Start initialization
        init();
    </script>
</body>
</html>
